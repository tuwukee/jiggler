#!/usr/bin/env ruby

require "securerandom"
require "async"
require "debug"
require_relative "../lib/jiggler"
require_relative "../lib/jiggler/launcher"

SIGNALS = %w[INT TERM TTIN TSTP].freeze

exit_code = 1

begin
  uuid = SecureRandom.uuid
  config = Jiggler.default_config
  config[:uuid] = uuid
  launcher = Jiggler::Launcher.new(config)
  Jiggler.logger.info("Starting Jiggler: #{uuid}")
  Jiggler.logger.info("Configuration: #{Jiggler.config.inspect}")
  launcher.run
rescue => e
  Jiggler.logger.error(e.message)
  Jiggler.logger.error(e.backtrace.join("\n"))
ensure
  launcher && launcher.cleanup
  Jiggler.logger.info("Exiting with code: #{exit_code}")
  exit(exit_code)
end

